name: Nightly Build

on:
  workflow_dispatch:
  schedule:
    # 中国时间每天凌晨 2 点
    - cron: '0 18 * * *'

env:
  BUN_VERSION: 1.3.5
  BUN_INSTALL_CACHE_DIR: .bun-install-cache.local

  PARATRANZ_TOKEN: ${{ secrets.PARATRANZ_TOKEN }}
  PARATRANZ_PROJECT_ID: ${{ secrets.PARATRANZ_PROJECT_ID }}

  GIT_AUTHOR: MuXiu1997 <muxiu1997@muxiu1997.com>
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  REPO_PATH: .repo
  ASSETS_PATH: .assets
  PARATRANZ_CACHE_DIR: .paratranz-cache

jobs:
  nightly-build:
    name: Nightly Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout MuXiu1997/GTNH-translation-compare
        uses: actions/checkout@v6
        with:
          repository: MuXiu1997/GTNH-translation-compare
          ref: main
      - name: Ensure Dependencies
        uses: ./.github/actions/ensure-dependencies
      - name: Checkout
        uses: actions/checkout@v6
        with:
          path: ${{ env.REPO_PATH }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5
      - name: Setup Bun Global Module Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.BUN_INSTALL_CACHE_DIR }}
          key: bun-install-cache--${{ github.job }}

      - name: Setup Datetime Related Envs
        run: bun run ${{ env.REPO_PATH }}/.github/scripts/setup-nightly-build-datetime-envs.ts

      - name: ParaTranz To Quest Book
        run: >-
          poetry run python main.py action paratranz-to-quest-book
          --repo-path='${{ env.REPO_PATH }}'
      - name: ParaTranz To Lang And zs
        run: >-
          poetry run python main.py action paratranz-to-lang-and-zs
          --repo-path='${{ env.REPO_PATH }}'
      - name: ParaTranz To GT Lang
        run: >-
          poetry run python main.py action paratranz-to-gt-lang
          --repo-path='${{ env.REPO_PATH }}'

      - name: Build Nightly Assets
        env:
          IS_NIGHTLY_BUILD: 'true'
          ARCHIVE_NAME: nightly-${{ env.NB_LOCAL_DATE }}.7z
        run: bun run ${{ env.REPO_PATH }}/.github/scripts/release.ts

      - name: Push tag
        working-directory: ${{ env.REPO_PATH }}
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git checkout --orphan temp
          git reset HEAD -- .
          git commit --allow-empty -m "Nightly Build ${{ env.NB_LOCAL_DATE }} ${{ env.NB_LOCAL_TIME }}"
          git tag ${{ env.NB_TAG }}
          git push --delete origin ${{ env.NB_TAG }} || true
          git push origin ${{ env.NB_TAG }}
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NB_TAG }}
          name: 每日构建 - ${{ env.NB_LOCAL_DATE }}
          body: |
            请阅读主页ReadMe以获知详细用法

            自动构建于 ${{ env.NB_LOCAL_DATE }} ${{ env.NB_LOCAL_TIME }}
          files: ${{ env.ASSETS_PATH }}/*

  cleanup-outdated-nightly-builds:
    name: Cleanup Outdated Nightly Builds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: .github/scripts

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5
      - name: Setup Bun Global Module Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.BUN_INSTALL_CACHE_DIR }}
          key: bun-install-cache--${{ github.job }}

      - name: Setup Datetime Related Envs
        run: bun run .github/scripts/setup-nightly-build-datetime-envs.ts

      - name: Cleanup Outdated Nightly Builds
        run: bun run .github/scripts/cleanup-nightly-builds.ts
